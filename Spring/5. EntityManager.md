# 5. EntityManager

Hibernate 프레임워크에서 가장 중요한 역할을 하는 클래스다.
데이터를 처리하는 메서드와 영속성 컨텍스트 기능을 제공한다. 
다른말로하면 DB에서 Entity 객체를 처리하는 기능과 캐시 기능을 제공한다.

이에 대해서 알아보자.

## 사용
EntityManager는 Spring에서 자동으로 Bean 객체를 생성하여
컨테이너에 저장한다.

따라서 EntityManager를 사용하고 싶으면 그냥 주입시켜서 사용하면 된다.
```java
@Autowired
private final EntityManager em;
```
생성자로 주입시켜도 된다.

하지만 Spring Data JPA 에서 사용하는 JpaRepository에서는 
모든 처리 과정에서 EntityManager를 사용한다.

save(), delete(), find...() 같은 메서드 내부에서 EntityManager를 호출하기 때문에
사실상 JapRepository는 EntityManager와 떼려고 해도야 뗄수없는 그런 관계다.


## `영속성 컨텍스트란`

원래의 `EntityManager`에서는 `remove()`를 호출할 경우에 바로 delete SQL 문이 날라간다.
즉, remove()와 SQL 쿼리의 실행이 동기화되어서 처리된다.

하지만 JPA/Hibernate 에서는 다른 방식으로 작동한다.
`remove()`를 실행하면 바로 SQL 쿼리가 발생하는 것이 아니라,
영속성 컨테이너에서 먼저 삭제가 되고 이후에 delete SQL문이 날라간다.
이것을 영속성 컨테이너의 `지연쓰기`라고 한다.

```scss
+---------+        +-------------------+        +---------------+
|   DB    | <--->  | 영속성 컨테이너(PC)|  <---> | EntityManager |
+---------+        +-------------------+        +---------------+

```

위와같은 구조를 통해서 데이터를 처리한다. 


영속성 컨텍스트는 Entity 객체들을 모아놓은 집합을 말하는데, 캐시같은 거라고 생각하면 된다.
DB에서 매번 데이터를 꺼내오거나, 바로 동기적으로 쿼리를 날리는 것이
많은 비용이 들어가기 때문에 `영속성 컨텍스트`를 통해 모아뒀다가 한번에 쿼리를 날리는 용도이다.


### `영속성 컨텍스트 기능`
`EntityManager`는 위 영속성 컨텍스트를 사용할 수 있는 기능을 제공한다.
- 영속성 컨텍스트의 생명주기 관리 메서드
  - persist()
  - remove()
  - flush()
  - getReference()


참고로 EntityManager는 `멀티 스레드`에 안전하지 않다.
따라서 스레드 마다 객체를 생성해야한다. 
SpringBoot에서는 자동으로 생성해주니 걱정말고 그냥 주입받자. 

DB에 Entity를 저장시킬 때에는 `Connection 객체`를 사용하여 쿼리를 실행시킨다.


### `객체 상태`
영속성 컨텍스트는 4가지 상태로 객체를 관리한다. 그리고 이 상태에 맞게 (INSERT, UPDATE, SELECT, DELETE) 등의 SQL쿼리를 날린다.

#### `비영속 상태`
엔티티 객체가 영속성 컨텍스트에 포함되지 않는 상태. 단순하게 new 로 생성한 객체가 비영속 상태라고 보면 된다.
  
#### `영속 상태`

- 준영속 상태
- 삭제 상태