# 메모리 작동 방식의 이해

## `개요`

메모리는 컴퓨터의 성능을 결정하는 중요한 장치이다. 프로그램을 실행시키 위해서는 반드시 메모리에 올려놓고 읽어야하기 때문이다. 따라서 메모리 용량이 클수록, 읽는 속도가 빠를수록 성능에 유리하다.

이러한 메모리를 어떻게 관리하고, 프로그램을 메모리에 어떻게 올리는지에 대해서 정리하였다.

## `물리적 메모리`
메모리 주소는 `물리적 주소`와 `논리적 주소`로 나누어진다.

메인 메모리는 다수의 `cell`로 구성되어있고, cell은 여러 `bit`로 구성되어있다. 이 bit 하나하나가 실제 메인 메모리의 주소를 뜻하고 이를 `물리적 주소`이라고 한다.

하지만 우리는 프로그래밍을 할때, 실제 `물리적 주소`을 사용하지 않고 변수, 수식등을 이용하여 주소를 할당하는데 이를 `논리적 주소`라고 한다. 컴파일러가 컴파일하는 과정에서 이 `논리적 주소`를 어느 `물리적 주소`에 맵핑 시켜야할지를 알려주고 이를 담은 실행파일(Object file)을 만들어 준다.

## `가상 주소 공간`

프로세스 전체를 한번에 연속된 메모리 공간에 올리기 어렵다. 이로인해 프로세스 동작에 어려움이 생긴다. 프로세스는 상대적인 주소값으로 실행할 코드와 변수값 등을 찾아낸다(ex. 현재 위치에서 + 100번째 라인). 따라서 프로세스의 코드, 주소를 상대적인 주소값으로 읽어내기 위해서는 프로그램 코드 전체가 연속된 공간 속에 있을 필요가 있다. 이를 위해 OS는 `가상(논리) 주소 공간`을 사용한다. 가상 주소 공간은 프로세스를 실행하기 위해 필요한 전체 정보를 담고있는 가상의 공간이다. 이를 여러 영역으로 분리하여 관리하고, 참조한다.

![JSON 이미지 3](https://i.sstatic.net/Drwcy.png)

### 커널 영역
커널영역은 OS와 연결되어 있는 영역이다. 프로세스 실행 중 입출력, 네트워크, 메모리관리 등을 처리할 필요가 있을 때 해당 영역에 저장되어있는 코드를 사용한다.

### Stack 영역
함수를 호출할 때 생기는 지역변수, 리턴 주소, 매개변수 등을 저장하는 공간이다. Data 영역의 변수와 달리, Stack 영역의 변수들은 실행시에 자동으로 값이 NULL로 할당되지 않는다. 함수 호출 시에 메모리를 사용하고 종료시 메모리를 자동으로 반환한다.

### Heap 영역
동적으로 메모리를 할당해서 사용하는 공간이다. malloc, new, free 등으로 할당할 수 있다. 많은 데이터를 할당할 경우 `메모리 누수`의 문제가 발생할 수 있는데, 이는 아래에 기술하도록 하겠다.


### Data 영역
전역변수, static 변수, 초기화된 배열 등이 사용하는 공간이다.
Data 영역은 다시 Data, BSS 2개의 영역으로 나누어진다.

`data 영역` 에서는 초기값이 할당되어 있는 변수를 저장한다. const 상수, format 문자열 (%s, %d)등이 저장된다.

`bass 영역`에서는 초기화되지 않은 전역/정적 변수가 저장되는 곳이다. 프로그램을 실행하면 자동으로 NULL(0)값으로 초기화된다.


### TEXT(코드) 영역
기계어로 변환된 코드가 올라가는 영역이다. 프로그램 실행시에 가장 먼저 메모리에 올라가고, 이 기계어들을 하나씩 읽어나간다.
읽기 전용 영역으로 이 영역에 데이터를 쓰려고 시도하면 에러가 액세스 위반 에러가 발생한다.


Data영역과 Text 영역은 컴파일 시에 주소가 할당 되고, 힙과 스택은 프로그램을 실행할 때 주소가 결정된다.


## 실제 프로그램이 메모리에 올라와서 실행되는 과정

우리가 실제 프로그램을 실행시킬 때 어떤 과정을 거쳐 실행될까?

실행 파일을 통해 프로그램을 실행시키면, DISK에 있는 파일을 메모리에 올린다.
이때 전체 파일을 올리는 것이 아니라 실행에 필요한 `코드(기계어)`, `전역변수` 등이 메모리에 올라가야한다. 따라서 코드영역과 Data 영역의 일부가 메모리에 올라간다.

CPU가 코드영역에 있는 기계어들을 통해 한줄 한줄 실행하다가 메모리에 올라와있지 않은 논리 주소에 접근해야하는 경우, OS가 해당 영역을 논리 주소공간에서 찾아 물리 메모리 공간에 적재한다.

이 과정을 반복하다가 메모리가 가득 찬 경우에, 메모리 관리 방법에 따라 사용하지 않는 영역을 DISK(스왑 영역)로 내리고 필요한 영역을 메모리로 가져온다.
